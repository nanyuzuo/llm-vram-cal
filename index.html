<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM 显存计算器 (VRAM Calculator)</title>
    <!-- 引入 Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- 引入 Tailwind CSS 美化界面 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 图标库 -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f3f4f6; }
        .slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #3b82f6; cursor: pointer; border-radius: 50%; }
        [v-cloak] { display: none; }
    </style>
</head>
<body class="text-gray-800">

<div id="app" v-cloak class="max-w-3xl mx-auto p-4 sm:p-8">
    
    <!-- 标题区 -->
    <div class="text-center mb-10">
        <h1 class="text-4xl font-bold text-gray-900 mb-2">大模型显存计算器</h1>
        <p class="text-gray-500">输入 HuggingFace 模型 ID，一键计算本地部署所需显存</p>
    </div>

    <!-- 输入控制区 -->
    <div class="bg-white rounded-xl shadow-lg p-6 mb-8 transition-all duration-300 hover:shadow-xl">
        
        <!-- 1. 模型名称输入 -->
        <div class="mb-6 relative">
            <label class="block text-sm font-medium text-gray-700 mb-2">模型名称 (HuggingFace ID)</label>
            <div class="flex gap-2">
                <input 
                    v-model="modelId" 
                    @keyup.enter="fetchModelInfo"
                    type="text" 
                    placeholder="例如: deepseek-ai/DeepSeek-R1" 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition"
                >
                <button 
                    @click="fetchModelInfo" 
                    :disabled="loading"
                    class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-medium transition flex items-center gap-2 disabled:opacity-50">
                    <i v-if="loading" class="fas fa-spinner fa-spin"></i>
                    <span v-else>搜索</span>
                </button>
            </div>
            <!-- 快捷推荐 -->
            <div class="mt-2 text-xs text-gray-500 flex gap-2 flex-wrap">
                <span class="cursor-pointer hover:text-blue-600 underline" @click="setModel('Qwen/Qwen3-30B-A3B')">Qwen/Qwen3-30B-A3B</span>
                <span class="cursor-pointer hover:text-blue-600 underline" @click="setModel('meta-llama/Llama-4-Scout-17B-16E-Instruct')">Llama-4-Scout-17B (需Token)</span>
                <span class="cursor-pointer hover:text-blue-600 underline" @click="setModel('deepseek-ai/DeepSeek-OCR')">DeepSeek-OCR</span>
                <span class="cursor-pointer hover:text-blue-600 underline" @click="setModel('deepseek-ai/DeepSeek-V3.1-Base')">DeepSeek-V3.1-Base</span>
                <span class="cursor-pointer hover:text-blue-600 underline" @click="setModel('Tongyi-MAI/Z-Image-Turbo')">Z-Image-Turbo</span>
            </div>

            <!-- Token 输入 -->
            <div class="mt-4">
                <details class="text-sm text-gray-500">
                    <summary class="cursor-pointer hover:text-blue-600 select-none flex items-center gap-1">
                        <i class="fas fa-key"></i> 配置 HF Token (访问门控模型)
                    </summary>
                    <div class="mt-2 p-3 bg-gray-50 rounded-lg border border-gray-200">
                        <label class="block text-xs font-medium text-gray-700 mb-1">Hugging Face Access Token</label>
                        <input 
                            v-model="hfToken" 
                            type="password" 
                            placeholder="hf_..." 
                            class="w-full p-2 border border-gray-300 rounded text-sm focus:ring-1 focus:ring-blue-500 outline-none bg-white"
                        >
                        <p class="mt-1 text-xs text-gray-400">Token 仅用于本次请求，不会上传服务器。</p>
                    </div>
                </details>
            </div>
        </div>

        <!-- 错误提示 -->
        <div v-if="error" class="bg-red-50 text-red-600 p-3 rounded-lg mb-4 text-sm flex items-center gap-2">
            <i class="fas fa-exclamation-circle"></i> {{ error }}
        </div>

        <div v-if="modelConfig" class="animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                <!-- 2. 量化选择 -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">模型权重精度</label>
                        <select v-model="quantization" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="fp16">BF16 / FP16 (原版)</option>
                            <option value="q8">Int8 (8-bit)</option>
                            <option value="q6_k">Q6_K (GGUF)</option>
                            <option value="q5_k_m">Q5_K_M (推荐均衡)</option>
                            <option value="q4_k_m">Q4_K_M (GGUF 推荐)</option>
                            <option value="q3_k_m">Q3_K_M (GGUF 极限)</option>
                            <option value="gptq_int4">GPTQ-4bit (仅限 N卡)</option>
                            <option value="awq_int4">AWQ-4bit (仅限 N卡)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">KV Cache 精度</label>
                        <select v-model="kvPrecision" class="w-full p-3 border border-gray-300 rounded-lg bg-white focus:ring-2 focus:ring-blue-500 outline-none">
                            <option value="fp16">FP16 (默认)</option>
                            <option value="int8">Int8 / FP8</option>
                            <option value="int4">Int4</option>
                        </select>
                        <p class="text-xs text-orange-500 mt-1"><i class="fas fa-exclamation-triangle"></i> 量化 KV Cache 可能导致性能下降，一般不推荐。</p>
                    </div>
                </div>

                <!-- 3. 上下文长度滑块 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2 flex justify-between">
                        <span>上下文窗口 (Context Length)</span>
                        <span class="text-blue-600 font-bold">{{ contextLength.toLocaleString() }} tokens</span>
                    </label>
                    <input 
                        type="range" 
                        v-model.number="contextLength" 
                        min="512" 
                        max="131072" 
                        step="512"
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer slider-thumb"
                    >
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span>512</span>
                        <span>32k</span>
                        <span>128k</span>
                    </div>
                </div>
            </div>

            <!-- 模型基本信息展示 -->
            <div class="bg-blue-50 p-3 rounded-lg text-sm text-blue-800 flex flex-wrap gap-4 mb-6">
                <div><i class="fas fa-layer-group"></i> 层数: <b>{{ modelConfig.num_hidden_layers }}</b></div>
                <div><i class="fas fa-ruler-horizontal"></i> 维度: <b>{{ modelConfig.hidden_size }}</b></div>
                <div><i class="fas fa-brain"></i> 注意力头: <b>{{ modelConfig.num_attention_heads }}</b></div>
                <div><i class="fas fa-key"></i> Attention: <b>{{ attnType }}</b></div>
                <div><i class="fas fa-weight-hanging"></i> 估算参数量: <b>{{ (estimatedParams / 1000000000).toFixed(2) }}B</b></div>
            </div>
        </div>
    </div>

    <!-- 结果展示区 -->
    <div v-if="modelConfig" class="grid grid-cols-1 md:grid-cols-3 gap-6">
        
        <!-- 总显存卡片 -->
        <div class="md:col-span-2 bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl shadow-lg p-6 text-white relative overflow-hidden">
            <div class="relative z-10">
                <h3 class="text-lg opacity-90 mb-1">预计所需总显存</h3>
                <div class="text-5xl font-bold mb-4">{{ totalVram.toFixed(1) }} GB</div>
                
                <!-- 进度条可视化 -->
                <div class="w-full bg-blue-900/50 h-4 rounded-full overflow-hidden flex mb-2">
                    <div class="bg-yellow-400 h-full" :style="{ width: (vramStats.weights / totalVram * 100) + '%' }" title="模型权重"></div>
                    <div class="bg-green-400 h-full" :style="{ width: (vramStats.kv / totalVram * 100) + '%' }" title="KV Cache"></div>
                    <div class="bg-gray-400 h-full" :style="{ width: (vramStats.overhead / totalVram * 100) + '%' }" title="系统开销"></div>
                </div>
                <div class="flex gap-4 text-xs opacity-80">
                    <span class="flex items-center gap-1"><div class="w-2 h-2 bg-yellow-400 rounded-full"></div> 权重</span>
                    <span class="flex items-center gap-1"><div class="w-2 h-2 bg-green-400 rounded-full"></div> 上下文(KV)</span>
                    <span class="flex items-center gap-1"><div class="w-2 h-2 bg-gray-400 rounded-full"></div> 系统预留</span>
                </div>
            </div>
            <!-- 背景装饰 -->
            <i class="fas fa-microchip absolute -bottom-4 -right-4 text-9xl text-white opacity-10"></i>
        </div>

        <!-- 推荐显卡卡片 -->
        <div class="bg-white rounded-xl shadow-lg p-6 flex flex-col justify-center items-center text-center border-t-4" :class="gpuRecommendation.color">
            <h3 class="text-gray-500 font-medium mb-2">推荐显卡配置</h3>
            <div class="text-2xl font-bold text-gray-800 mb-2">{{ gpuRecommendation.name }}</div>
            <span class="px-3 py-1 rounded-full text-sm font-medium" :class="gpuRecommendation.badgeBg">{{ gpuRecommendation.vram }} VRAM</span>
        </div>

        <!-- 详细明细 -->
        <div class="md:col-span-3 bg-white rounded-xl shadow p-6">
            <h3 class="font-bold text-gray-700 mb-4 border-b pb-2">详细消耗明细</h3>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-sm">
                <div class="p-3 bg-yellow-50 rounded border border-yellow-100">
                    <div class="text-gray-500 mb-1">静态权重 (Model Weights)</div>
                    <div class="text-xl font-semibold text-yellow-700">{{ vramStats.weights.toFixed(2) }} GB</div>
                    <div class="text-xs text-gray-400 mt-1">取决于参数量和量化精度</div>
                </div>
                <div class="p-3 bg-green-50 rounded border border-green-100">
                    <div class="text-gray-500 mb-1">KV Cache (上下文)</div>
                    <div class="text-xl font-semibold text-green-700">{{ vramStats.kv.toFixed(2) }} GB</div>
                    <div class="text-xs text-gray-400 mt-1">Type: {{ attnType }} {{ isMLA ? '✨' : (isGQA ? '✅' : '') }}</div>
                </div>
                <div class="p-3 bg-gray-50 rounded border border-gray-100">
                    <div class="text-gray-500 mb-1">系统开销 (Overhead)</div>
                    <div class="text-xl font-semibold text-gray-700">{{ vramStats.overhead.toFixed(2) }} GB</div>
                    <div class="text-xs text-gray-400 mt-1">CUDA内核 + 激活值缓冲区</div>
                </div>
            </div>
        </div>

    </div>
    
    <div class="mt-12 text-center text-sm text-gray-400">
        <p>此工具仅为估算，实际占用可能受具体推理框架（vLLM, llama.cpp, HF）影响。</p>
        <p>Powered by Vue.js & HuggingFace API</p>
    </div>

</div>

<script>
    const { createApp, ref, computed, watch } = Vue;

    createApp({
        setup() {
            const modelId = ref('deepseek-ai/DeepSeek-R1'); // 改为非门控模型作为默认
            const hfToken = ref(''); // 新增 Token 存储
            const loading = ref(false);
            const error = ref(null);
            const modelConfig = ref(null);
            
            // 用户设置
            const contextLength = ref(8192);
            const quantization = ref('q4_k_m');
            const kvPrecision = ref('fp16');

            // 快捷设置模型
            const setModel = (name) => {
                modelId.value = name;
                fetchModelInfo();
            };

            // 获取 HF 模型信息
            const fetchModelInfo = async () => {
                if (!modelId.value) return;
                loading.value = true;
                error.value = null;
                modelConfig.value = null;

                try {
                    // 构建请求头
                    const headers = {};
                    if (hfToken.value) {
                        headers['Authorization'] = `Bearer ${hfToken.value}`;
                    }

                    // 使用 HF API 获取 Config
                    const response = await fetch(`https://huggingface.co/api/models/${modelId.value}`, { headers });
                    
                    if (response.status === 401 || response.status === 403) {
                        throw new Error('需要 HuggingFace Token 访问该模型 (门控模型)');
                    }
                    
                    if (!response.ok) throw new Error('未找到模型或连接 HF 失败');
                    
                    const data = await response.json();
                    let config = data.config;

                    // 预处理 Config：映射别名字段
                    const normalizeConfig = (c) => {
                        if (!c) return c;
                        // 映射常见别名到标准字段
                        if (!c.num_hidden_layers) c.num_hidden_layers = c.n_layers || c.layers || c.depth;
                        if (!c.hidden_size) c.hidden_size = c.dim || c.d_model || c.n_embd;
                        if (!c.num_attention_heads) c.num_attention_heads = c.n_heads || c.heads;
                        if (!c.num_key_value_heads) c.num_key_value_heads = c.n_kv_heads || c.n_heads || c.num_attention_heads;
                        return c;
                    };

                    config = normalizeConfig(config);

                    // 检查 Config 完整性
                    // 1. 如果 API 返回的 config 不完整，尝试获取根目录 config.json
                    if (!config || !config.num_hidden_layers || !config.hidden_size) {
                        try {
                            const configResponse = await fetch(`https://huggingface.co/${modelId.value}/resolve/main/config.json`, { headers });
                            if (configResponse.ok) {
                                const fullConfig = await configResponse.json();
                                config = { ...config, ...normalizeConfig(fullConfig) };
                            }
                        } catch (e) {
                            console.warn('Fetching root config.json failed', e);
                        }
                    }

                    // 2. 如果仍然不完整，尝试获取 transformer/config.json (针对 DiT/Diffusion 模型)
                    if (!config || !config.num_hidden_layers || !config.hidden_size) {
                        try {
                            const subConfigResponse = await fetch(`https://huggingface.co/${modelId.value}/resolve/main/transformer/config.json`, { headers });
                            if (subConfigResponse.ok) {
                                const subConfig = await subConfigResponse.json();
                                config = { ...config, ...normalizeConfig(subConfig) };
                            }
                        } catch (e) {
                             console.warn('Fetching transformer/config.json failed', e);
                        }
                    }

                    // 最终检查
                    if (!config || !config.num_hidden_layers || !config.hidden_size) {
                         throw new Error('模型配置文件不完整 (缺失 layers/hidden_size)，尝试读取 transformer/config.json 也失败。');
                    }

                    modelConfig.value = config;
                    
                    // 自动调整默认上下文窗口
                    if (config.max_position_embeddings) {
                        const maxCtx = config.max_position_embeddings;
                        contextLength.value = maxCtx > 32000 ? 8192 : Math.min(maxCtx, 8192);
                    } else if (config.sample_size) {
                        // 对于图像生成模型，通常没有 text context 概念，给一个默认值
                        contextLength.value = 1024; 
                    }

                } catch (e) {
                    error.value = e.message;
                } finally {
                    loading.value = false;
                }
            };

            // 1. 估算参数量 (Billion)
            // 如果 API 没有直接返回参数量，我们需要根据架构估算
            const estimatedParams = computed(() => {
                if (!modelConfig.value) return 0;
                const c = modelConfig.value;
                
                // 核心参数
                const L = c.num_hidden_layers || 32;
                const H = c.hidden_size || 4096;
                const V = c.vocab_size || 32000;
                
                // Expert Intermediate Size
                // DeepSeek V2/V3 uses moe_intermediate_size
                const expertSize = c.moe_intermediate_size || c.intermediate_size || (H * 4);
                
                // MoE (Mixture of Experts) 检测
                // n_routed_experts: DeepSeek V2/V3
                // num_local_experts: Mixtral
                // num_experts: Qwen-MoE
                const numRoutedExperts = c.n_routed_experts || c.num_local_experts || c.num_experts || 0;
                const numSharedExperts = c.n_shared_experts || 0;
                
                const isMoE = numRoutedExperts > 0;
                const totalExperts = isMoE ? (numRoutedExperts + numSharedExperts) : 1;

                // 简单估算公式
                // Attn = 4 * H^2 (query, key, value, out)
                const attnParams = 4 * H * H; 
                
                // MLP (SwiGLU) = 3 * H * expertSize * totalExperts
                const mlpParams = totalExperts * 3 * H * expertSize;
                
                const layerParams = attnParams + mlpParams;
                
                const total = (L * layerParams) + (V * H);
                
                return total;
            });

            // 2. Attention 类型检测 (GQA / MLA)
            const attnType = computed(() => {
                if (!modelConfig.value) return 'Standard';
                const c = modelConfig.value;
                // MLA (DeepSeek V2/V3)
                if (c.kv_lora_rank && c.kv_lora_rank > 0) return 'MLA';
                // GQA
                const kv = c.num_key_value_heads;
                const attn = c.num_attention_heads;
                if (kv && kv < attn) return 'GQA';
                return 'Standard';
            });

            // 兼容旧变量用于显示
            const isGQA = computed(() => attnType.value === 'GQA');
            const isMLA = computed(() => attnType.value === 'MLA');

            // 3. 计算各项显存
            const vramStats = computed(() => {
                if (!modelConfig.value) return { weights: 0, kv: 0, overhead: 0 };

                // A. 权重显存
                // 量化系数 (Bytes per param)
                // FP16 = 2, Q8 = 1, Q4_K_M ≈ 0.65 (含 overhead), Q6 ≈ 0.75
                const bpwMap = {
                    'fp16': 2.0,
                    'q8': 1.0,
                    'q6_k': 0.75, // approximate
                    'q5_k_m': 0.68,
                    'q4_k_m': 0.60, // 加上 metadata 实际上通常在 0.6 左右
                    'q3_k_m': 0.48,
                    'gptq_int4': 0.55,
                    'awq_int4': 0.55
                };
                const bpw = bpwMap[quantization.value] || 2.0;
                const weightsVram = (estimatedParams.value * bpw) / (1024 ** 3); // GB

                // B. KV Cache 显存
                const c = modelConfig.value;
                const layers = c.num_hidden_layers;
                const seq = contextLength.value;
                
                // KV 量化系数
                const kvBpwMap = { 'fp16': 2.0, 'int8': 1.0, 'int4': 0.5 };
                const kvBpw = kvBpwMap[kvPrecision.value] || 2.0;

                let kvBytesPerToken = 0;

                if (attnType.value === 'MLA') {
                    // DeepSeek MLA: Compressed KV
                    // Cache = (kv_lora_rank + qk_rope_head_dim) * Layers
                    const kvLoraRank = c.kv_lora_rank || 512;
                    const qkRopeHeadDim = c.qk_rope_head_dim || 64;
                    const dim = kvLoraRank + qkRopeHeadDim;
                    kvBytesPerToken = layers * dim * kvBpw; 
                } else {
                    // Standard / GQA
                    const heads = c.num_attention_heads;
                    const kvHeads = c.num_key_value_heads || heads;
                    
                    // 优先使用 config.head_dim，否则使用 hidden/heads
                    const headDim = c.head_dim || (c.hidden_size / heads);
                    
                    // Cache = 2 * Layers * KV_Heads * HeadDim * BytesPerElement
                    kvBytesPerToken = 2 * layers * kvHeads * headDim * kvBpw; 
                }
                
                const kvVram = (kvBytesPerToken * seq) / (1024 ** 3);

                // C. 系统开销 (Overhead)
                // 包含 CUDA Context (约 500MB-1GB) + Activation Buffer (临时变量)
                // 临时变量通常与 batch size 和 context 有关，这里给一个基础值
                let overhead = 0.6; // 基础 600MB
                // 随着 context 增加，激活值也会增加
                overhead += (kvVram * 0.1); // 简单估算

                return {
                    weights: weightsVram,
                    kv: kvVram,
                    overhead: overhead
                };
            });

            const totalVram = computed(() => {
                const s = vramStats.value;
                return s.weights + s.kv + s.overhead;
            });

            // 4. 显卡推荐逻辑
            const gpuRecommendation = computed(() => {
                const v = totalVram.value;
                // 判断是否为 N卡 专用量化 (GPTQ/AWQ)
                const isNvidiaOnly = ['gptq_int4', 'awq_int4'].includes(quantization.value);

                if (v <= 6) return { name: 'RTX 3060 / 4060 (6G+)', vram: '8GB', color: 'border-green-500', badgeBg: 'bg-green-100 text-green-800' };
                if (v <= 8) return { name: 'RTX 3070 / 4060Ti', vram: '8GB', color: 'border-green-500', badgeBg: 'bg-green-100 text-green-800' };
                if (v <= 11) return { name: 'RTX 2080Ti / 3080 (10G+)', vram: '12GB', color: 'border-blue-500', badgeBg: 'bg-blue-100 text-blue-800' };
                if (v <= 12) return { name: 'RTX 3060 12G / 4070', vram: '12GB', color: 'border-blue-500', badgeBg: 'bg-blue-100 text-blue-800' };
                
                // 16GB 档位
                if (v <= 16) {
                    const name = isNvidiaOnly ? 'RTX 4080 / 4060Ti 16G' : 'RTX 4080 / Mac M1/M2/M3 Pro';
                    return { name: name, vram: '16GB', color: 'border-indigo-500', badgeBg: 'bg-indigo-100 text-indigo-800' };
                }
                
                // 24GB 档位
                if (v <= 24) {
                    const name = isNvidiaOnly ? 'RTX 3090 / 4090' : 'RTX 4090 / Mac M1/M2/M3 Max';
                    return { name: name, vram: '24GB', color: 'border-purple-500', badgeBg: 'bg-purple-100 text-purple-800' };
                }
                
                // 48GB 档位
                if (v <= 48) {
                    const name = isNvidiaOnly ? 'RTX 6000 / A6000' : 'RTX 6000 / Mac Studio (64G)';
                    return { name: name, vram: '48GB', color: 'border-purple-500', badgeBg: 'bg-purple-100 text-purple-800' };
                }
                
                // > 48GB
                const name = isNvidiaOnly ? '多卡并联 (Dual 3090/4090)' : 'Mac Studio (Ultra) / 多卡并联';
                return { name: name, vram: '>48GB', color: 'border-red-500', badgeBg: 'bg-red-100 text-red-800' };
            });

            // 初始化
            fetchModelInfo();

            return {
                modelId, hfToken, loading, error, modelConfig, 
                contextLength, quantization, kvPrecision, setModel, fetchModelInfo,
                estimatedParams, isGQA, isMLA, attnType, vramStats, totalVram, gpuRecommendation
            };
        }
    }).mount('#app');
</script>
</body>
</html>

